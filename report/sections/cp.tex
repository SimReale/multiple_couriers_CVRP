\section{CP}
The CP models are set in an \textit{incremental way}, starting from a base structure with the foundamental constraints of the problem and then adding implied and symmetry breaking ones. After fixing the models, a final exploration on the search strategy is provided to optimize the solving procedure.



\subsection{Decision variables}
The CP models are based on the following decision variables:
\begin{itemize}
    \item $x_{c, i} \in NODES$, with $c \in COURIERS$ and $i \in NODES$, which defines the construction of the paths for each courier, meaning that $x_{c, i} = j$ if the courier $c$ goes from the node $i$ to $j$, where $n+1$ is the \textit{depot}.
    
    \item $bins_i \in COURIERS$, with $i \in ITEMS$, where setting $bins_i = c$ means that the item $i$ is assigned to the courier $c$.
    
    \item $load_c \in [min\_load\ ..\ max\_load]$, with $c \in COURIERS$, that is an \textit{auxiliary variable} used to assign the load carried by each courier in the solution, where $min\_load$ and $max\_load$ are respectively the \textit{lower bound} and the \textit{upper bound} of the load values:
    \begin{quote}
        \centering
        $min\_load = min(s)$, $max\_load = max(l)$.
    \end{quote}
\end{itemize}



\subsection{Objective function}
The \textit{objective function} is defined through the distance matrix $D$ given as input and the paths $x$ in the following way:
\begin{equation}
    \max_{c \in COURIERS} \left( \sum_{i \in NODES:\ x_{c, i} \neq i} D_{i, x_{c, i}} \right)
\end{equation}



\subsection{Constraints}
The main problem structure is defined through the following constraints.
\begin{itemize}
    \item \texttt{bin\_packing\_capa}

        This global constraint taken from the MiniZinc library ensures that the actual load carried by each courier, given by the sum of its item sizes, is lower than its overall capacity. Mathematically speaking, it is defined by:
        \begin{equation}
        \forall c \in COURIERS: \left( \sum_{i \in ITEMS:\ bins_i = c} s_i \right) \leq l_c.
        \end{equation}
        The global version has been preferred to the explicit one, due to a more optimized implementation provided by MiniZinc for performances.
    
    \item \textbf{Couriers assignment and Channelling constraint}

        It defines how the items must be assigned to the couriers and links the $bins$ and $x$ matrices in the following way:
        \begin{equation}
            \forall c \in COURIERS,
            \forall i \in ITEMS: 
            \begin{cases}
                x_{c, i} = i    & \text{if $bins_i \neq c$} \\
                x_{c, i} \neq i & \text{if $bins_i = c$} 
            \end{cases}
        \end{equation}
    
    \item \texttt{subcircuit}

        Again, it is a MiniZinc global constraint, that models the fact that $x$ is the \textit{successors matrix of each node}, guaranteeing that each courier forms an Hamiltonian cycle through its nodes assignments. Therefore, this contraint is applied on each row of the $x$ matrix.

    \item \textbf{Couriers departure}

        It states explicitly that each courier must take at least one pack and not stay in the depot, due to performance optimization:
        \begin{equation}
            \forall c \in COURIERS:\ x_{c, n+1} \neq n+1 
        \end{equation}

\end{itemize}

\subsubsection{Implied constraints}
The only implied constraint has been added to the model to improve the performance through the introduction of the variable $load$ and is \texttt{bin\_packing\_load}. It assigns the load of each courier as the sum of the items' sizes $s$, depending on the assignments in $bins$ and is defined mathematically as:
\begin{equation}
    \forall c \in COURIERS: \left( \sum_{i \in ITEMS:\ bins_i = c} s_i \right) = load_c.
\end{equation}

\subsubsection{Symmetry breaking constraints}
Experimental trials showed that too much symmetry breaking constraints cause the performance to worsen, so only one symmetry breaking about the load is left in the related model. In particular, it is the \texttt{lex\_lesseq}, which imposes the lexicographic ordering on the couriers assignments of two items if the items have the same size and the couriers have the same load carried:
\begin{quote}
    \centering
    $\forall i \in ITEMS, \forall j \in ITEMS:$
\end{quote}
\begin{equation}
    (s_i = s_j \land load[bins_i] = load[bins_j]) \implies lex\_lesseq([bins_i,\ bins_j])
\end{equation}



\subsection{Validation}

\subsubsection{Experimental design}
The models are evaluated using as solvers both \textit{Gecode} and \textit{Chuffed}, with ad-hoc search strategies, in order to fully exploit the potential of each solver. After making different experiments on the variable assignation, it came up that $x$ is the variable matrix that most influences the exploration of the search tree. However, different choices have been taken for Gecode and Chuffed, depending on the their availability of \textit{variable selection} and \textit{domain selection} strategies.
\begin{itemize}
    \item \textbf{Gecode:}

        The exploration of the search tree is managed by the \texttt{int\_default\_search}, which is the type of integer search that is properly suited on the Gecode solver. It turned out that the best annotation choices for this strategy are \texttt{afc\_size\_max} for variables, together with a random choice for the value assignment (\texttt{indomain\_random}). 

        In addition, a restart strategy has been added, based on the \textit{Luby sequence}, in combination with the \textit{Local Neighborhood Search (LNS)}. From previous experiments, we noticed that low values of the retain percentage did not influence much the exploration. Therefore, it has been set to the $80\%$, referring to the $x$ matrix.

    \item \textbf{Chuffed:}

        The search strategy is split in two parts. In the beginning, the last column of $x$, containing the routes \textit{depot-item}, is assigned in order to address the exploration starting from the first items to deliver. Then, the rest of the path is assigned consequently.

        The best variable selection strategy found is \texttt{first\_fail} on both the steps explained above, combined with a restart policy that follows the \textit{Luby sequence}.
\end{itemize}

\subsubsection{Experimental results}

\begin{table}[ht]
    \caption{Selected subset of CP results. Results in \textbf{bold} are solved to optimality. Instances that are all solved to optimality have been omitted.}
    \label{tab:cp_results}
    \centerline{
        \begin{tabular}{c|ccccccc}
            \toprule
            & \multicolumn{4}{c}{Gecode} & \multicolumn{3}{c}{Chuffed} \\
            %\cmidrule(lr){2-5} \cmidrule(lr){6-8}
            Id & \rot{base}        & \rot{implied}     & \rot{implied_lns} & \rot{SB}          & \rot{base}        & \rot{implied_rs}  & \rot{SB}          \\ 
            \midrule
            1  & \textbf{14}       & \textbf{14}       & 14                & 14                & \textbf{14}       & \textbf{14}       & \textbf{14}       \\ 
            2  & \textbf{226}      & \textbf{226}      & \textbf{226}      & \textbf{226}      & \textbf{226}      & \textbf{226}      & \textbf{226}      \\
            3  & \textbf{12}       & \textbf{12}       & 12                & 18                & \textbf{12}       & \textbf{12}       & \textbf{12}       \\
            4  & \textbf{220}      & \textbf{220}      & \textbf{220}      & \textbf{220}      & \textbf{220}      & \textbf{220}      & \textbf{220}      \\
            5  & \textbf{206}      & \textbf{206}      & \textbf{206}      & \textbf{206}      & \textbf{206}      & \textbf{206}      & \textbf{206}      \\
            6  & \textbf{322}      & \textbf{322}      & \textbf{322}      & \textbf{322}      & \textbf{322}      & \textbf{322}      & \textbf{322}      \\
            7  & \textbf{167}      & \textbf{167}      & \textbf{167}      & \textbf{167}      & \textbf{167}      & \textbf{167}      & \textbf{167}      \\
            8  & \textbf{186}      & \textbf{186}      & \textbf{186}      & \textbf{186}      & \textbf{186}      & \textbf{186}      & \textbf{186}      \\
            9  & \textbf{436}      & \textbf{436}      & \textbf{436}      & \textbf{436}      & \textbf{436}      & \textbf{436}      & \textbf{436}      \\
            10 & \textbf{244}      & \textbf{244}      & \textbf{244}      & \textbf{244}      & \textbf{244}      & \textbf{244}      & \textbf{244}      \\ 
            11 & 847               & 847               & 388               & 426               & --                & 913               & 913               \\ 
            12 & 457               & 402               & \textbf{346}      & \textbf{346}      & --                & \textbf{346}      & \textbf{346}      \\ 
            13 & 1316              & 1316              & 496               & 524               & --                & 1102              & 1102              \\ 
            14 & 1232              & 1224              & 748               & 782               & --                & 1299              & 1304              \\ 
            15 & 1088              & 1088              & 650               & --                & --                & 1016              & 1016              \\ 
            16 & 496               & 496               & \textbf{286}      & \textbf{286}      & --                & \textbf{286}      & \textbf{286}      \\ 
            17 & 1435              & 1467              & 941               & --                & --                & 1428              & 1449              \\ 
            18 & 985               & 801               & 554               & 638               & --                & 1133              & 1125              \\ 
            19 & 476               & 476               & \textbf{334}      & \textbf{334}      & --                & \textbf{334}      & \textbf{334}      \\ 
            20 & 1784              & 1809              & 896               & --                & --                & 1319              & 1319              \\ 
            21 & 635               & 756               & 414               & 501               & --                & 1085              & 1077              \\ 
            \bottomrule
        \end{tabular}
    }
\end{table}

For Gecode, we experimented different search approaches by testing restart methods, large neighborhood search (LNS), and varying symmetry breaking constraints. We observed that, compared to a depth-first approach, by simply restarting search following the Luby sequence there is a mixed impact on the results with both positive and negative effects. Instead, by also using LNS, results tend to improve globally and we observed that a higher retain probability, with a peak at around $95\%$, works better. Regarding symmetry breaking constraints, we observed that they tend to worsen the final objective value in the majority of the cases, most reasonably due to the fact that the overhead to impose them is higher than the speed-up in search. For a visual comparison, we show in \Cref{fig:cp_obj_plots} the evolution of the objective value during search. It can be seen that without restart the objective stops improving in the early stages of search as it most likely gets ``stuck" in a branch of the search tree. By introducing some non-determinism, the objective reaches lower values, with LNS being the fastest and best performing.

\begin{figure}[H]
    \centering
    \begin{subfigure}{0.49\linewidth}
        \centering
        \includegraphics[width=\linewidth]{img/cp/obj-plot_inst12.pdf}
        \caption{Instance 12}
    \end{subfigure}
    \hfill
    \begin{subfigure}{0.49\linewidth}
        \centering
        \includegraphics[width=\linewidth]{img/cp/obj-plot_inst16.pdf}
        \caption{Instance 16}
    \end{subfigure}
    \caption{Intermediate solutions using Gecode}
    \label{fig:cp_obj_plots}
\end{figure}

For Chuffed, we only experimented with restarts and symmetry breaking constraints as LNS is not available through MiniZinc. Moreover, as indicated in the documentation\footnote{\url{https://docs.minizinc.dev/en/stable/solvers.html}}, we tried enabling free search mode but only obtained worse results. Compared to Gecode, results on bigger instances are generally all worse, while smaller instances tend to be solved faster by Chuffed. As in Gecode, restarts, which we only experimented with random variable selection as it is the only non-deterministic search strategy available, and symmetry breaking constraints both yield mixed effects on the final result.

Finally, for OR-Tools, we conducted fewer experiments as it supports fewer MiniZinc annotations. In this case, we observed that enabling free search mode allows obtaining better results and, similarly to Gecode and Chuffed, symmetry breaking constraints have mixed results. As a side note, we must also observe that, as suggested in the documentation, these results are worse as OR-Tools performs better with multi-threading.